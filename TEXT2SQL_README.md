# ğŸ¦Œ DeerFlow Text2SQL System

## ğŸ‰ å®Œæ•´åŠŸèƒ½å®ç°

æˆ‘ä»¬æˆåŠŸå°† ti-flow çš„ Text2SQL åŠŸèƒ½å®Œæ•´ç§»æ¤åˆ° deer-flowï¼ŒåŒ…æ‹¬æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ã€å®æ—¶ç›‘æ§å’Œç”¨æˆ·ç•Œé¢ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### åç«¯æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Routes    â”‚    â”‚   Services      â”‚    â”‚  Repositories   â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ SQLç”Ÿæˆ       â”‚â”€â”€â”€â–¶â”‚ â€¢ Text2SQL      â”‚â”€â”€â”€â–¶â”‚ â€¢ Text2SQL      â”‚
â”‚ â€¢ æŸ¥è¯¢æ‰§è¡Œ      â”‚    â”‚ â€¢ å‘é‡å­˜å‚¨      â”‚    â”‚ â€¢ æ•°æ®åº“è¿æ¥    â”‚
â”‚ â€¢ è®­ç»ƒç®¡ç†      â”‚    â”‚ â€¢ æ•°æ®æºç®¡ç†    â”‚    â”‚ â€¢ ç¼“å­˜ç®¡ç†      â”‚
â”‚ â€¢ WebSocket     â”‚    â”‚                 â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Celery Tasks  â”‚    â”‚   WebSocket     â”‚    â”‚   PostgreSQL    â”‚
â”‚                 â”‚    â”‚   Manager       â”‚    â”‚   + pgvector    â”‚
â”‚ â€¢ æ¨¡å‹è®­ç»ƒ      â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ å‘é‡ç”Ÿæˆ      â”‚    â”‚ â€¢ å®æ—¶è¿›åº¦      â”‚    â”‚ â€¢ æŸ¥è¯¢å†å²      â”‚
â”‚ â€¢ æ•°æ®æ¸…ç†      â”‚    â”‚ â€¢ çŠ¶æ€æ¨é€      â”‚    â”‚ â€¢ è®­ç»ƒæ•°æ®      â”‚
â”‚                 â”‚    â”‚ â€¢ è¿æ¥ç®¡ç†      â”‚    â”‚ â€¢ å‘é‡ç´¢å¼•      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‰ç«¯æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Settings Page                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Overview      â”‚  â”‚   Query         â”‚  â”‚   Training   â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ â€¢ ç»Ÿè®¡ä¿¡æ¯      â”‚  â”‚ â€¢ SQLç”Ÿæˆç•Œé¢   â”‚  â”‚ â€¢ è®­ç»ƒæ•°æ®   â”‚ â”‚
â”‚  â”‚ â€¢ æˆåŠŸç‡        â”‚  â”‚ â€¢ æŸ¥è¯¢æ‰§è¡Œ      â”‚  â”‚ â€¢ æ•°æ®ç®¡ç†   â”‚ â”‚
â”‚  â”‚ â€¢ è®­ç»ƒæ•°æ®åˆ†å¸ƒ  â”‚  â”‚ â€¢ ç»“æœå±•ç¤º      â”‚  â”‚ â€¢ æ‰¹é‡æ“ä½œ   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   Monitoring    â”‚  â”‚   Settings      â”‚                   â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚                   â”‚
â”‚  â”‚ â€¢ å®æ—¶æ´»åŠ¨      â”‚  â”‚ â€¢ æ¨¡å‹é…ç½®      â”‚                   â”‚
â”‚  â”‚ â€¢ è®­ç»ƒè¿›åº¦      â”‚  â”‚ â€¢ å‚æ•°è°ƒæ•´      â”‚                   â”‚
â”‚  â”‚ â€¢ WebSocket     â”‚  â”‚ â€¢ ç³»ç»Ÿè®¾ç½®      â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ ¸å¿ƒåŠŸèƒ½

### âœ… å·²å®ç°åŠŸèƒ½

#### ğŸ—„ï¸ æ•°æ®ç®¡ç†
- **æŸ¥è¯¢å†å²** - å®Œæ•´çš„ SQL ç”Ÿæˆå’Œæ‰§è¡Œè®°å½•
- **è®­ç»ƒæ•°æ®** - æ”¯æŒ SQLã€Schemaã€æ–‡æ¡£ç­‰å¤šç§ç±»å‹
- **SQL ç¼“å­˜** - æ™ºèƒ½æŸ¥è¯¢ç¼“å­˜å’Œç›¸ä¼¼åº¦æœç´¢
- **è®­ç»ƒä¼šè¯** - æ¨¡å‹è®­ç»ƒä¼šè¯ç®¡ç†å’Œç›‘æ§

#### ğŸ§  AI åŠŸèƒ½
- **SQL ç”Ÿæˆ** - è‡ªç„¶è¯­è¨€è½¬ SQL
- **ç½®ä¿¡åº¦è¯„åˆ†** - AI æ¨¡å‹ç½®ä¿¡åº¦è¯„ä¼°
- **ç›¸ä¼¼æŸ¥è¯¢** - åŸºäºå‘é‡çš„ç›¸ä¼¼æŸ¥è¯¢æ¨è
- **è§£é‡Šç”Ÿæˆ** - SQL æŸ¥è¯¢è§£é‡Šå’Œè¯´æ˜

#### âš¡ åå°ä»»åŠ¡
- **æ¨¡å‹è®­ç»ƒ** - Celery å¼‚æ­¥è®­ç»ƒä»»åŠ¡
- **å‘é‡ç”Ÿæˆ** - è®­ç»ƒæ•°æ®å‘é‡åŒ–å¤„ç†
- **æ•°æ®æ¸…ç†** - å®šæœŸæ¸…ç†æ—§æ•°æ®
- **è¿›åº¦ç›‘æ§** - å®æ—¶ä»»åŠ¡è¿›åº¦è·Ÿè¸ª

#### ğŸŒ å®æ—¶é€šä¿¡
- **WebSocket ç®¡ç†** - å®æ—¶çŠ¶æ€æ¨é€
- **è®­ç»ƒè¿›åº¦** - å®æ—¶è®­ç»ƒè¿›åº¦ç›‘æ§
- **æŸ¥è¯¢çŠ¶æ€** - å®æ—¶æŸ¥è¯¢æ‰§è¡ŒçŠ¶æ€
- **ç³»ç»Ÿé€šçŸ¥** - ç³»ç»ŸçŠ¶æ€å’Œé”™è¯¯é€šçŸ¥

#### ğŸ¨ ç”¨æˆ·ç•Œé¢
- **SQL æŸ¥è¯¢ç•Œé¢** - è‡ªç„¶è¯­è¨€è¾“å…¥å’Œ SQL ç”Ÿæˆ
- **è®­ç»ƒæ•°æ®ç®¡ç†** - å¯è§†åŒ–è®­ç»ƒæ•°æ®ç®¡ç†
- **ç»Ÿè®¡ä»ªè¡¨æ¿** - ç³»ç»Ÿä½¿ç”¨ç»Ÿè®¡å’Œåˆ†æ
- **å®æ—¶ç›‘æ§** - å®æ—¶æ´»åŠ¨å’Œä»»åŠ¡ç›‘æ§

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–
```bash
cd deer-flow
pip install -e .
```

### 2. æ•°æ®åº“è¿ç§»
```bash
make migrate
```

### 3. å¯åŠ¨æœåŠ¡
```bash
# å¯åŠ¨ Redis (åå°ä»»åŠ¡é˜Ÿåˆ—)
redis-server --port 6380 &

# å¯åŠ¨ Celery Worker (åå°ä»»åŠ¡å¤„ç†)
celery -A src.tasks.text2sql_tasks worker --loglevel=info --concurrency=2 &

# å¯åŠ¨ FastAPI æœåŠ¡å™¨
python -m uvicorn src.server.app:app --host 0.0.0.0 --port 8000 --reload
```

### 4. è®¿é—®ç•Œé¢
- **API æ–‡æ¡£**: http://localhost:8000/docs
- **Text2SQL API**: http://localhost:8000/api/text2sql
- **å‰ç«¯æµ‹è¯•**: http://localhost:8000/test_frontend.html
- **è®¾ç½®é¡µé¢**: http://localhost:3000/settings (éœ€è¦å¯åŠ¨å‰ç«¯)

## ğŸ§ª æµ‹è¯•

### åŸºç¡€åŠŸèƒ½æµ‹è¯•
```bash
make test-basic
```

### å®Œæ•´ç³»ç»Ÿæµ‹è¯•
```bash
make test-text2sql
```

### æœåŠ¡çŠ¶æ€æ£€æŸ¥
```bash
make status
```

## ğŸ“¡ API ç«¯ç‚¹

### SQL ç”Ÿæˆå’Œæ‰§è¡Œ
- `POST /api/text2sql/generate` - ç”Ÿæˆ SQL
- `POST /api/text2sql/execute` - æ‰§è¡Œ SQL
- `GET /api/text2sql/history` - æŸ¥è¯¢å†å²

### è®­ç»ƒæ•°æ®ç®¡ç†
- `POST /api/text2sql/training` - æ·»åŠ è®­ç»ƒæ•°æ®
- `GET /api/text2sql/training` - è·å–è®­ç»ƒæ•°æ®
- `DELETE /api/text2sql/training/{id}` - åˆ é™¤è®­ç»ƒæ•°æ®

### æ¨¡å‹è®­ç»ƒ
- `POST /api/text2sql/retrain/{datasource_id}` - é‡æ–°è®­ç»ƒæ¨¡å‹
- `POST /api/text2sql/training-session` - å¼€å§‹è®­ç»ƒä¼šè¯
- `GET /api/text2sql/training-sessions` - è·å–è®­ç»ƒä¼šè¯

### ç»Ÿè®¡å’Œç›‘æ§
- `GET /api/text2sql/statistics` - è·å–ç»Ÿè®¡ä¿¡æ¯
- `GET /api/text2sql/datasource/{id}/training-summary` - è®­ç»ƒæ‘˜è¦
- `WS /api/text2sql/ws/{datasource_id}` - WebSocket è¿æ¥

## ğŸ”§ é…ç½®

### ç¯å¢ƒå˜é‡
```bash
# æ•°æ®åº“é…ç½®
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=aolei_db
POSTGRES_USER=aolei
POSTGRES_PASSWORD=aolei123456

# Redis é…ç½®
REDIS_URL=redis://localhost:6380/0

# AI æ¨¡å‹é…ç½® (å¯é€‰)
OPENAI_API_KEY=your_openai_key
ANTHROPIC_API_KEY=your_anthropic_key
```

### æ•°æ®åº“æ¶æ„
- **text2sql.query_history** - æŸ¥è¯¢å†å²è®°å½•
- **text2sql.training_data** - è®­ç»ƒæ•°æ®
- **text2sql.sql_queries** - SQL æŸ¥è¯¢ç¼“å­˜
- **text2sql.training_sessions** - è®­ç»ƒä¼šè¯
- **text2sql.vanna_embeddings** - å‘é‡åµŒå…¥

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### 1. åˆ›å»ºæ•°æ®æº
```python
from src.services.database_datasource import DatabaseDatasourceService

service = DatabaseDatasourceService()
datasource = await service.create_datasource({
    "name": "My Database",
    "database_type": "POSTGRESQL",
    "host": "localhost",
    "port": 5432,
    "database_name": "mydb",
    "username": "user",
    "password": "pass"
})
```

### 2. ç”Ÿæˆ SQL
```python
from src.services.text2sql import Text2SQLService

service = Text2SQLService()
response = await service.generate_sql({
    "datasource_id": 1,
    "question": "Show me all active users",
    "include_explanation": True
})
print(response.generated_sql)
```

### 3. æ·»åŠ è®­ç»ƒæ•°æ®
```python
await service.add_training_data({
    "datasource_id": 1,
    "content_type": "SQL",
    "content": "SELECT * FROM users WHERE active = true",
    "question": "Show me all active users",
    "sql_query": "SELECT * FROM users WHERE active = true"
})
```

## ğŸ”„ å¼€å‘å·¥ä½œæµ

1. **å¼€å‘ç¯å¢ƒè®¾ç½®**
   ```bash
   make install-dev
   make migrate
   ```

2. **å¯åŠ¨å¼€å‘æœåŠ¡**
   ```bash
   make dev
   ```

3. **è¿è¡Œæµ‹è¯•**
   ```bash
   make test-basic
   make test-text2sql
   ```

4. **åœæ­¢æœåŠ¡**
   ```bash
   make stop
   ```

## ğŸ“ˆ æ€§èƒ½ç‰¹ç‚¹

- **å¼‚æ­¥å¤„ç†** - æ‰€æœ‰ I/O æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„
- **è¿æ¥æ± ** - æ•°æ®åº“è¿æ¥æ± ç®¡ç†
- **ç¼“å­˜æœºåˆ¶** - æ™ºèƒ½æŸ¥è¯¢ç¼“å­˜
- **å‘é‡æœç´¢** - pgvector é«˜æ€§èƒ½å‘é‡æœç´¢
- **å®æ—¶é€šä¿¡** - WebSocket ä½å»¶è¿Ÿé€šä¿¡
- **åå°ä»»åŠ¡** - Celery åˆ†å¸ƒå¼ä»»åŠ¡å¤„ç†

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

- **åªè¯»æ¨¡å¼** - æ•°æ®æºå¯é…ç½®ä¸ºåªè¯»
- **SQL éªŒè¯** - ç”Ÿæˆçš„ SQL å®‰å…¨éªŒè¯
- **æƒé™æ§åˆ¶** - åŸºäºæ•°æ®æºçš„æƒé™ç®¡ç†
- **é”™è¯¯å¤„ç†** - å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

## ğŸ”® æœªæ¥æ‰©å±•

- **æ›´å¤š AI æ¨¡å‹** - æ”¯æŒæ›´å¤š AI æ¨¡å‹æä¾›å•†
- **é«˜çº§åˆ†æ** - æŸ¥è¯¢æ€§èƒ½åˆ†æå’Œä¼˜åŒ–å»ºè®®
- **æ‰¹é‡æ“ä½œ** - æ‰¹é‡ SQL ç”Ÿæˆå’Œæ‰§è¡Œ
- **æ•°æ®å¯è§†åŒ–** - æŸ¥è¯¢ç»“æœå¯è§†åŒ–
- **API é™æµ** - API è°ƒç”¨é¢‘ç‡é™åˆ¶
- **å®¡è®¡æ—¥å¿—** - å®Œæ•´çš„æ“ä½œå®¡è®¡æ—¥å¿—

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æŸ¥çœ‹ï¼š
- API æ–‡æ¡£: http://localhost:8000/docs
- æµ‹è¯•é¡µé¢: http://localhost:8000/test_frontend.html
- æ—¥å¿—æ–‡ä»¶: æ£€æŸ¥åº”ç”¨æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯

---

ğŸ‰ **æ­å–œï¼Text2SQL ç³»ç»Ÿå·²å®Œå…¨é›†æˆåˆ° DeerFlow ä¸­ï¼**
